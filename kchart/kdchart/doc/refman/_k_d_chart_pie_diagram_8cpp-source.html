<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>KD Chart 2: KDChartPieDiagram.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>KDChartPieDiagram.cpp</h1><a href="_k_d_chart_pie_diagram_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment"> ** Copyright (C) 2006 Klar채lvdalens Datakonsult AB.  All rights reserved.</span>
00003 <span class="comment"> **</span>
00004 <span class="comment"> ** This file is part of the KD Chart library.</span>
00005 <span class="comment"> **</span>
00006 <span class="comment"> ** This file may be distributed and/or modified under the terms of the</span>
00007 <span class="comment"> ** GNU General Public License version 2 as published by the Free Software</span>
00008 <span class="comment"> ** Foundation and appearing in the file LICENSE.GPL included in the</span>
00009 <span class="comment"> ** packaging of this file.</span>
00010 <span class="comment"> **</span>
00011 <span class="comment"> ** Licensees holding valid commercial KD Chart licenses may use this file in</span>
00012 <span class="comment"> ** accordance with the KD Chart Commercial License Agreement provided with</span>
00013 <span class="comment"> ** the Software.</span>
00014 <span class="comment"> **</span>
00015 <span class="comment"> ** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</span>
00016 <span class="comment"> ** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00017 <span class="comment"> **</span>
00018 <span class="comment"> ** See http://www.kdab.net/kdchart for</span>
00019 <span class="comment"> **   information about KDChart Commercial License Agreements.</span>
00020 <span class="comment"> **</span>
00021 <span class="comment"> ** Contact info@kdab.net if any conditions of this</span>
00022 <span class="comment"> ** licensing are not clear to you.</span>
00023 <span class="comment"> **</span>
00024 <span class="comment"> **********************************************************************/</span>
00025 
00026 <span class="preprocessor">#include &lt;QDebug&gt;</span>
00027 <span class="preprocessor">#include &lt;QPainter&gt;</span>
00028 <span class="preprocessor">#include &lt;QStack&gt;</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="_k_d_chart_attributes_model_8h.html">KDChartAttributesModel.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="_k_d_chart_paint_context_8h.html">KDChartPaintContext.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="_k_d_chart_pie_diagram_8h.html">KDChartPieDiagram.h</a>"</span>
00033 <span class="preprocessor">#include "KDChartPieDiagram_p.h"</span>
00034 <span class="preprocessor">#include "<a class="code" href="_k_d_chart_pie_attributes_8h.html">KDChartPieAttributes.h</a>"</span>
00035 <span class="preprocessor">#include "<a class="code" href="_k_d_chart_three_d_pie_attributes_8h.html">KDChartThreeDPieAttributes.h</a>"</span>
00036 <span class="preprocessor">#include "KDChartPainterSaver_p.h"</span>
00037 <span class="preprocessor">#include "<a class="code" href="_k_d_chart_data_value_attributes_8h.html">KDChartDataValueAttributes.h</a>"</span>
00038 
00039 <span class="preprocessor">#include &lt;KDABLibFakes&gt;</span>
00040 
00041 
00042 <span class="keyword">using</span> <span class="keyword">namespace </span>KDChart;
00043 
00044 PieDiagram::Private::Private()
00045 {
00046 }
00047 
00048 PieDiagram::Private::~Private() {}
00049 
<a name="l00050"></a><a class="code" href="_k_d_chart_pie_diagram_8cpp.html#a0">00050</a> <span class="preprocessor">#define d d_func()</span>
00051 <span class="preprocessor"></span>
<a name="l00052"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama42">00052</a> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama42">PieDiagram::PieDiagram</a>( <a class="code" href="class_q_widget.html">QWidget</a>* parent, <a class="code" href="class_k_d_chart_1_1_polar_coordinate_plane.html">PolarCoordinatePlane</a>* plane ) :
00053     <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html">AbstractPieDiagram</a>( new Private(), parent, plane )
00054 {
00055     init();
00056 }
00057 
<a name="l00058"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama87">00058</a> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama87">PieDiagram::~PieDiagram</a>()
00059 {
00060 }
00061 
00062 <span class="keywordtype">void</span> PieDiagram::init()
00063 {
00064 }
00065 
<a name="l00066"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama6">00066</a> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html">PieDiagram</a> * <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama6">PieDiagram::clone</a>()<span class="keyword"> const</span>
00067 <span class="keyword"></span>{
00068     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama42">PieDiagram</a>( <span class="keyword">new</span> Private( *<a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a> ) );
00069 }
00070 
<a name="l00071"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb1">00071</a> <span class="keyword">const</span> QPair&lt;QPointF, QPointF&gt; <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb1">PieDiagram::calculateDataBoundaries</a> ()<span class="keyword"> const</span>
00072 <span class="keyword"></span>{
00073     <span class="keywordflow">if</span> ( !<a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagramb2">checkInvariants</a>( <span class="keyword">true</span> ) ) <span class="keywordflow">return</span> QPair&lt;QPointF, QPointF&gt;( QPointF( 0, 0 ), QPointF( 0, 0 ) );
00074 
00075     <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_pie_attributes.html">PieAttributes</a> attrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama41">pieAttributes</a>( model()-&gt;index( 0, 0, rootIndex() ) ) );
00076 
00077     QPointF bottomLeft ( QPointF( 0, 0 ) );
00078     QPointF topRight;
00079     <span class="comment">// If we explode, we need extra space for the pie slice that has</span>
00080     <span class="comment">// the largest explosion distance.</span>
00081     <span class="keywordflow">if</span> ( attrs.<a class="code" href="class_k_d_chart_1_1_pie_attributes.html#_k_d_chart_1_1_pie_attributesa0">explode</a>() ) {
00082         <span class="keyword">const</span> <span class="keywordtype">int</span> colCount = <a class="code" href="class_k_d_chart_1_1_abstract_polar_diagram.html#_k_d_chart_1_1_ring_diagrama7">columnCount</a>();
00083         qreal maxExplode = 0.0;
00084         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j = 0; j &lt; colCount; ++j ){
00085             <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_pie_attributes.html">PieAttributes</a> columnAttrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama41">pieAttributes</a>( model()-&gt;index( 0, j, rootIndex() ) ) );
00086             maxExplode = qMax( maxExplode, columnAttrs.<a class="code" href="class_k_d_chart_1_1_pie_attributes.html#_k_d_chart_1_1_pie_attributesa1">explodeFactor</a>() );
00087         }
00088         topRight = QPointF( 1.0+maxExplode, 1.0+maxExplode );
00089     }<span class="keywordflow">else</span>{
00090         topRight = QPointF( 1.0, 1.0 );
00091     }
00092     <span class="keywordflow">return</span> QPair&lt;QPointF, QPointF&gt; ( bottomLeft,  topRight );
00093 }
00094 
00095 
<a name="l00096"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb8">00096</a> <span class="keywordtype">void</span> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb8">PieDiagram::paintEvent</a>( QPaintEvent* )
00097 {
00098     QPainter painter ( viewport() );
00099     <a class="code" href="class_k_d_chart_1_1_paint_context.html">PaintContext</a> ctx;
00100     ctx.<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta5">setPainter</a> ( &amp;painter );
00101     ctx.<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta6">setRectangle</a>( QRectF ( 0, 0, width(), height() ) );
00102     <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb6">paint</a> ( &amp;ctx );
00103 }
00104 
<a name="l00105"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb11">00105</a> <span class="keywordtype">void</span> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb11">PieDiagram::resizeEvent</a> ( QResizeEvent*)
00106 {
00107 }
00108 
<a name="l00109"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama44">00109</a> <span class="keywordtype">void</span> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama44">PieDiagram::resize</a> ( <span class="keyword">const</span> QSizeF&amp; )
00110 {
00111 }
00112 
<a name="l00113"></a><a class="code" href="_k_d_chart_pie_diagram_8cpp.html#a1">00113</a> <span class="keyword">static</span> QRectF <a class="code" href="_k_d_chart_pie_diagram_8cpp.html#a1">buildReferenceRect</a>( <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_polar_coordinate_plane.html">PolarCoordinatePlane</a>* plane )
00114 {
00115     QRectF contentsRect;
00116 <span class="comment">//qDebug() &lt;&lt; "..........................................";</span>
00117     QPointF referencePointAtTop = plane-&gt;<a class="code" href="class_k_d_chart_1_1_polar_coordinate_plane.html#_k_d_chart_1_1_polar_coordinate_planea66">translate</a>( QPointF( 1, 0 ) );
00118     QPointF temp = plane-&gt;<a class="code" href="class_k_d_chart_1_1_polar_coordinate_plane.html#_k_d_chart_1_1_polar_coordinate_planea66">translate</a>( QPointF( 0, 0 ) ) - referencePointAtTop;
00119     <span class="keyword">const</span> <span class="keywordtype">double</span> offset = temp.y();
00120     referencePointAtTop.setX( referencePointAtTop.x() - offset );
00121     contentsRect.setTopLeft( referencePointAtTop );
00122     contentsRect.setBottomRight( referencePointAtTop + QPointF( 2*offset, 2*offset) );
00123 <span class="comment">//qDebug() &lt;&lt; contentsRect;</span>
00124     <span class="keywordflow">return</span> contentsRect;
00125 }
00126 <span class="comment">/*</span>
00127 <span class="comment">void PieDiagram::paint( PaintContext* ctx )</span>
00128 <span class="comment">{</span>
00129 <span class="comment">    if ( !checkInvariants(true) ) return;</span>
00130 <span class="comment">    const int colCount = model()-&gt;columnCount(rootIndex());</span>
00131 <span class="comment">    QRectF contentsRect = buildReferenceRect( polarCoordinatePlane() );</span>
00132 <span class="comment">    DataValueTextInfoList list;</span>
00133 <span class="comment">    double startAngle = startPosition();</span>
00134 <span class="comment">    double startAngleValueSpace = valueTotals() / 360 * startAngle;</span>
00135 <span class="comment">    for ( int j=0; j&lt;colCount; ++j ) {</span>
00136 <span class="comment">        const double nextValue = qAbs( model()-&gt;data( model()-&gt;index( 0, j,rootIndex() ) ).toDouble() );</span>
00137 <span class="comment">        double spanAngle = polarCoordinatePlane()-&gt;translatePolar( QPointF( nextValue, 1 ) ).x();</span>
00138 <span class="comment">        if ( spanAngle == 0 ) continue;</span>
00139 <span class="comment">        QBrush brush = qVariantValue&lt;QBrush&gt;( attributesModel()-&gt;headerData( j, Qt::Vertical, KDChart::DatasetBrushRole ) );</span>
00140 <span class="comment">        QPen pen = qVariantValue&lt;QPen&gt;( attributesModel()-&gt;headerData( j, Qt::Vertical, KDChart::DatasetPenRole ) );</span>
00141 <span class="comment">        PainterSaver painterSaver( ctx-&gt;painter() );</span>
00142 <span class="comment">        ctx-&gt;painter()-&gt;setRenderHint ( QPainter::Antialiasing );</span>
00143 <span class="comment">        ctx-&gt;painter()-&gt;setBrush( brush );</span>
00144 <span class="comment">        ctx-&gt;painter()-&gt;setPen( pen );</span>
00145 <span class="comment"></span>
00146 <span class="comment">        // Explosion support</span>
00147 <span class="comment">        QRectF pieRect = contentsRect;</span>
00148 <span class="comment">        if( explode() ) {</span>
00149 <span class="comment">            QPointF oldCenter = contentsRect.center();</span>
00150 <span class="comment">            QPointF newCenter = polarCoordinatePlane()-&gt;translate( QPointF( explodeFactor( j ),</span>
00151 <span class="comment">                                                                            startAngleValueSpace + nextValue/2.0 ) );</span>
00152 <span class="comment">            QPointF difference = newCenter - oldCenter;</span>
00153 <span class="comment">            pieRect.translate( difference );</span>
00154 <span class="comment">        }</span>
00155 <span class="comment"></span>
00156 <span class="comment">        ctx-&gt;painter()-&gt;drawPie( pieRect, ( int ) ((-startAngle + 90 )), ( int ) (-spanAngle) );</span>
00157 <span class="comment">        startAngle += spanAngle;</span>
00158 <span class="comment">        startAngleValueSpace += nextValue;</span>
00159 <span class="comment">    }</span>
00160 <span class="comment">    DataValueTextInfoListIterator it( list );</span>
00161 <span class="comment">    while ( it.hasNext() ) {</span>
00162 <span class="comment">        const DataValueTextInfo&amp; info = it.next();</span>
00163 <span class="comment">        paintDataValueText( ctx-&gt;painter(), info.index, info.pos, info.value );</span>
00164 <span class="comment">    }</span>
00165 <span class="comment">}</span>
00166 <span class="comment">*/</span>
00167 
00168 
<a name="l00169"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb6">00169</a> <span class="keywordtype">void</span> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagramb6">PieDiagram::paint</a>( <a class="code" href="class_k_d_chart_1_1_paint_context.html">PaintContext</a>* ctx )
00170 {
00171     <span class="comment">// note: Not having any data model assigned is no bug</span>
00172     <span class="comment">//       but we can not draw a diagram then either.</span>
00173     <span class="keywordflow">if</span> ( !<a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagramb2">checkInvariants</a>(<span class="keyword">true</span>) )
00174         <span class="keywordflow">return</span>;
00175 
00176     <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_pie_attributes.html">PieAttributes</a> attrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama41">pieAttributes</a>() );
00177     <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_three_d_pie_attributes.html">ThreeDPieAttributes</a> threeDAttrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama79">threeDPieAttributes</a>( model()-&gt;index( 0, 0, rootIndex() ) ) );
00178 
00179     <span class="keyword">const</span> <span class="keywordtype">int</span> colCount = <a class="code" href="class_k_d_chart_1_1_abstract_polar_diagram.html#_k_d_chart_1_1_ring_diagrama7">columnCount</a>();
00180 
00181     QRectF contentsRect( <a class="code" href="_k_d_chart_pie_diagram_8cpp.html#a1">buildReferenceRect</a>( <a class="code" href="class_k_d_chart_1_1_abstract_polar_diagram.html#_k_d_chart_1_1_ring_diagrama42">polarCoordinatePlane</a>() ) );
00182     contentsRect = ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta3">rectangle</a>();
00183 <span class="comment">//    contentsRect = geometry();</span>
00184 <span class="comment">//qDebug() &lt;&lt; contentsRect;</span>
00185     <span class="keywordflow">if</span>( contentsRect.isEmpty() )
00186         <span class="keywordflow">return</span>;
00187 
00188     DataValueTextInfoList list;
00189     <span class="keyword">const</span> qreal sum = <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama83">valueTotals</a>();
00190 
00191     <span class="keywordflow">if</span>( sum == 0.0 ) <span class="comment">//nothing to draw</span>
00192         <span class="keywordflow">return</span>;
00193 
00194     <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles.resize( colCount );
00195     <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens.resize( colCount );
00196 
00197     <span class="comment">// compute position</span>
00198     <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size = qMin( contentsRect.width(), contentsRect.height() ); <span class="comment">// initial size</span>
00199 
00200     <span class="comment">// if the pies explode, we need to give them additional space =&gt;</span>
00201     <span class="comment">// make the basic size smaller</span>
00202     qreal maxExplode = 0.0;
00203     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j = 0; j &lt; colCount; ++j ){
00204         <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_pie_attributes.html">PieAttributes</a> columnAttrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama41">pieAttributes</a>( model()-&gt;index( 0, j, rootIndex() ) ) );
00205         maxExplode = qMax( maxExplode, columnAttrs.<a class="code" href="class_k_d_chart_1_1_pie_attributes.html#_k_d_chart_1_1_pie_attributesa1">explodeFactor</a>() );
00206     }
00207     <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size /= ( 1.0 + 2.0 * maxExplode );
00208 
00209 
00210     qreal sizeFor3DEffect = 0.0;
00211     <span class="keywordflow">if</span> ( ! threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa1">isEnabled</a>() ) {
00212 
00213         qreal x = ( contentsRect.width() == <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size ) ? 0.0 : ( ( contentsRect.width() - <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size ) / 2.0 );
00214         qreal y = ( contentsRect.height() == <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size ) ? 0.0 : ( ( contentsRect.height() - <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size ) / 2.0 );
00215         <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;position = QRectF( x, y, <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size, <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size );
00216         <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;position.translate( contentsRect.left(), contentsRect.top() );
00217     } <span class="keywordflow">else</span> {
00218         <span class="comment">// threeD: width is the maximum possible width; height is 1/2 of that</span>
00219         qreal x = ( contentsRect.width() == <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size ) ? 0.0 : ( ( contentsRect.width() - <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size ) / 2.0 );
00220         qreal height = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size;
00221         <span class="comment">// make sure that the height plus the threeDheight is not more than the</span>
00222         <span class="comment">// available size</span>
00223         <span class="keywordflow">if</span> ( threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>() &gt;= 0.0 ) {
00224             <span class="comment">// positive pie height: absolute value</span>
00225             sizeFor3DEffect = threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>();
00226             height = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size - sizeFor3DEffect;
00227         } <span class="keywordflow">else</span> {
00228             <span class="comment">// negative pie height: relative value</span>
00229             sizeFor3DEffect = - threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>() / 100.0 * height;
00230             height = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size - sizeFor3DEffect;
00231         }
00232         qreal y = ( contentsRect.height() == height ) ? 0.0 : ( ( contentsRect.height() - height - sizeFor3DEffect ) / 2.0 );
00233 
00234         <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;position = QRectF( contentsRect.left() + x, contentsRect.top() + y,
00235                 <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size, height );
00236         <span class="comment">//  d-&gt;position.moveBy( contentsRect.left(), contentsRect.top() );</span>
00237     }
00238 
00239     <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_polar_coordinate_plane.html">PolarCoordinatePlane</a> * plane = <a class="code" href="class_k_d_chart_1_1_abstract_polar_diagram.html#_k_d_chart_1_1_ring_diagrama42">polarCoordinatePlane</a>();
00240     <span class="keyword">const</span> qreal sectorsPerValue = 360.0 / sum;
00241     qreal currentValue = plane ? plane-&gt;<a class="code" href="class_k_d_chart_1_1_polar_coordinate_plane.html#_k_d_chart_1_1_polar_coordinate_planea63">startPosition</a>() : 0.0;
00242 
00243     <span class="keywordtype">bool</span> atLeastOneValue = <span class="keyword">false</span>; <span class="comment">// guard against completely empty tables</span>
00244     QVariant vValY;
00245     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> iColumn = 0; iColumn &lt; colCount; ++iColumn ) {
00246         <span class="comment">// is there anything at all at this column?</span>
00247         <span class="keywordtype">bool</span> bOK;
00248         <span class="keyword">const</span> <span class="keywordtype">double</span> cellValue = qAbs( model()-&gt;data( model()-&gt;index( 0, iColumn, rootIndex() ) )
00249             .toDouble( &amp;bOK ) );
00250 
00251         <span class="keywordflow">if</span>( bOK ){
00252             <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ iColumn ] = currentValue;
00253             <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ iColumn ] = cellValue * sectorsPerValue;
00254             atLeastOneValue = <span class="keyword">true</span>;
00255         } <span class="keywordflow">else</span> { <span class="comment">// mark as non-existent</span>
00256             <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ iColumn ] = 0.0;
00257             <span class="keywordflow">if</span> ( iColumn &gt; 0.0 )
00258                 <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ iColumn ] = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ iColumn - 1 ];
00259             <span class="keywordflow">else</span>
00260                 <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ iColumn ] = currentValue;
00261         }
00262         <span class="comment">//qDebug() &lt;&lt; "d-&gt;startAngles["&lt;&lt;iColumn&lt;&lt;"] == " &lt;&lt; d-&gt;startAngles[ iColumn ]</span>
00263         <span class="comment">//         &lt;&lt; " +  d-&gt;angleLens["&lt;&lt;iColumn&lt;&lt;"]" &lt;&lt; d-&gt;angleLens[ iColumn ]</span>
00264         <span class="comment">//         &lt;&lt; " = " &lt;&lt; d-&gt;startAngles[ iColumn ]+d-&gt;angleLens[ iColumn ];</span>
00265 
00266         currentValue = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ iColumn ] + <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ iColumn ];
00267     }
00268 
00269     <span class="comment">// If there was no value at all, bail out, to avoid endless loops</span>
00270     <span class="comment">// later on (e.g. in findPieAt()).</span>
00271     <span class="keywordflow">if</span>( ! atLeastOneValue )
00272         <span class="keywordflow">return</span>;
00273 
00274 
00275     <span class="comment">// Find the backmost pie which is at +90째 and needs to be drawn</span>
00276     <span class="comment">// first</span>
00277     <span class="keywordtype">int</span> backmostpie = findPieAt( 90, colCount );
00278     <span class="comment">// Find the frontmost pie (at -90째/+270째) that should be drawn last</span>
00279     <span class="keywordtype">int</span> frontmostpie = findPieAt( 270, colCount );
00280     <span class="comment">// the right- and the leftmost (only needed in some special cases...)</span>
00281     <span class="keywordtype">int</span> rightmostpie = findPieAt( 0, colCount );
00282     <span class="keywordtype">int</span> leftmostpie = findPieAt( 180, colCount );
00283 
00284 
00285     <span class="keywordtype">int</span> currentLeftPie = backmostpie;
00286     <span class="keywordtype">int</span> currentRightPie = backmostpie;
00287 
00288     drawOnePie( ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>(), 0, backmostpie, <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama21">granularity</a>(), sizeFor3DEffect );
00289 
00290     <span class="keywordflow">if</span>( backmostpie == frontmostpie )
00291     {
00292         <span class="keywordflow">if</span>( backmostpie == leftmostpie )
00293             currentLeftPie = findLeftPie( currentLeftPie, colCount );
00294         <span class="keywordflow">if</span>( backmostpie == rightmostpie )
00295             currentRightPie = findRightPie( currentRightPie, colCount );
00296     }
00297     <span class="keywordflow">while</span>( currentLeftPie != frontmostpie )
00298     {
00299         <span class="keywordflow">if</span>( currentLeftPie != backmostpie )
00300             drawOnePie( ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>(), 0, currentLeftPie, <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama21">granularity</a>(), sizeFor3DEffect );
00301         currentLeftPie = findLeftPie( currentLeftPie, colCount );
00302     }
00303     <span class="keywordflow">while</span>( currentRightPie != frontmostpie )
00304     {
00305         <span class="keywordflow">if</span>( currentRightPie != backmostpie )
00306             drawOnePie( ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>(), 0, currentRightPie, <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama21">granularity</a>(), sizeFor3DEffect );
00307         currentRightPie = findRightPie( currentRightPie, colCount );
00308     }
00309 
00310     <span class="comment">// if the backmost pie is not the frontmost pie, we draw the frontmost at last</span>
00311     <span class="keywordflow">if</span>( backmostpie != frontmostpie || ! <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama79">threeDPieAttributes</a>().<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa1">isEnabled</a>() )
00312     {
00313         drawOnePie( ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>(), 0, frontmostpie, <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama21">granularity</a>(), sizeFor3DEffect );
00314     <span class="comment">// else, this gets a bit mor complicated...</span>
00315     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama79">threeDPieAttributes</a>().<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa1">isEnabled</a>() ) {
00316         drawPieSurface( ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>(), 0, frontmostpie, <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama21">granularity</a>() );
00317         <span class="keyword">const</span> QModelIndex index = model()-&gt;index( 0, frontmostpie, rootIndex() );
00318         QPen pen = this-&gt;<a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagrama37">pen</a>( index );
00319         ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>()-&gt;setRenderHint ( QPainter::Antialiasing );
00320         ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>()-&gt;setBrush( <a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagrama5">brush</a>( index ) );
00321         <span class="keywordflow">if</span> ( threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa1">isEnabled</a>() )
00322             pen.setColor( QColor( 0, 0, 0 ) );
00323         ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>()-&gt;setPen( pen );
00324 
00325         qreal startAngle = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ frontmostpie ];
00326         <span class="keywordflow">if</span>( startAngle &gt; 360 )
00327             startAngle -= 360;
00328 
00329         qreal endAngle = startAngle + <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ frontmostpie ];
00330         startAngle = qMax( startAngle, 180.0 );
00331 
00332         drawArcEffectSegment( ctx-&gt;<a class="code" href="class_k_d_chart_1_1_paint_context.html#_k_d_chart_1_1_paint_contexta2">painter</a>(), piePosition( 0, frontmostpie),
00333                 sizeFor3DEffect, startAngle, endAngle, <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama21">granularity</a>() );
00334     }
00335 }
00336 
00337 <span class="preprocessor">#if defined ( Q_WS_WIN)</span>
00338 <span class="preprocessor"></span><span class="preprocessor">#define trunc(x) ((int)(x))</span>
00339 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00340 <span class="preprocessor"></span>
00341 QRectF PieDiagram::piePosition( uint dataset, uint pie )<span class="keyword"> const</span>
00342 <span class="keyword"></span>{
00343     qreal angleLen = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ pie ];
00344     qreal startAngle = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ pie ];
00345     QModelIndex index( model()-&gt;index( 0, pie, rootIndex() ) );
00346     <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_pie_attributes.html">PieAttributes</a> attrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama41">pieAttributes</a>( index ) );
00347     <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_three_d_pie_attributes.html">ThreeDPieAttributes</a> threeDAttrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama79">threeDPieAttributes</a>( index ) );
00348 
00349     QRectF drawPosition( <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;position );
00350 
00351     <span class="keywordflow">if</span> ( attrs.<a class="code" href="class_k_d_chart_1_1_pie_attributes.html#_k_d_chart_1_1_pie_attributesa0">explode</a>() ) {
00352         qreal explodeAngle = ( startAngle + angleLen / 2.0 );
00353         qreal explodeAngleRad = DEGTORAD( explodeAngle );
00354         qreal cosAngle = cos( explodeAngleRad );
00355         qreal sinAngle = -sin( explodeAngleRad );
00356         qreal explodeX = attrs.<a class="code" href="class_k_d_chart_1_1_pie_attributes.html#_k_d_chart_1_1_pie_attributesa1">explodeFactor</a>() * <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size * cosAngle;
00357         qreal explodeY = attrs.<a class="code" href="class_k_d_chart_1_1_pie_attributes.html#_k_d_chart_1_1_pie_attributesa1">explodeFactor</a>() * <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;size * sinAngle;
00358         drawPosition.translate( explodeX, explodeY );
00359     }<span class="keywordflow">else</span>{
00360         drawPosition = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;position;
00361     }
00362     <span class="keywordflow">return</span> drawPosition;
00363  }
00364 
00373 <span class="keywordtype">void</span> PieDiagram::drawOnePie( QPainter* painter,
00374         uint dataset, uint pie,
00375         qreal granularity,
00376         qreal threeDPieHeight )
00377 {
00378     <span class="comment">// Is there anything to draw at all?</span>
00379     qreal angleLen = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ pie ];
00380     <span class="keywordflow">if</span> ( angleLen ) {
00381   <span class="comment">//      qreal startAngle = d-&gt;startAngles[ pie ];</span>
00382 <span class="comment">/*</span>
00383 <span class="comment">        KDChartDataRegion* datReg = 0;</span>
00384 <span class="comment">        QRegion* region = 0;</span>
00385 <span class="comment">        bool mustDeleteRegion = false;</span>
00386 <span class="comment">        if ( regions ){</span>
00387 <span class="comment">            region = new QRegion();</span>
00388 <span class="comment">            mustDeleteRegion = true;</span>
00389 <span class="comment">        }</span>
00390 <span class="comment">*/</span>
00391         QModelIndex index( model()-&gt;index( 0, pie, rootIndex() ) );
00392         <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_pie_attributes.html">PieAttributes</a> attrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama41">pieAttributes</a>( index ) );
00393         <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_three_d_pie_attributes.html">ThreeDPieAttributes</a> threeDAttrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama79">threeDPieAttributes</a>( index ) );
00394 
00395         QRectF drawPosition = piePosition( dataset, pie );
00396 
00397         draw3DEffect( painter,
00398             drawPosition, dataset, pie,
00399             granularity,
00400             threeDAttrs,
00401             attrs.<a class="code" href="class_k_d_chart_1_1_pie_attributes.html#_k_d_chart_1_1_pie_attributesa0">explode</a>() );
00402 
00403         drawPieSurface( painter, dataset, pie, granularity );
00404     }
00405 }
00406 
00414 <span class="keywordtype">void</span> PieDiagram::drawPieSurface( QPainter* painter,
00415         uint dataset, uint pie,
00416         qreal granularity )
00417 {
00418     <span class="comment">// Is there anything to draw at all?</span>
00419     qreal angleLen = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ pie ];
00420     <span class="keywordflow">if</span> ( angleLen ) {
00421         qreal startAngle = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ pie ];
00422 <span class="comment">/*</span>
00423 <span class="comment">        KDChartDataRegion* datReg = 0;</span>
00424 <span class="comment">        QRegion* region = 0;</span>
00425 <span class="comment">        bool mustDeleteRegion = false;</span>
00426 <span class="comment">        if ( regions ){</span>
00427 <span class="comment">            region = new QRegion();</span>
00428 <span class="comment">            mustDeleteRegion = true;</span>
00429 <span class="comment">        }</span>
00430 <span class="comment">*/</span>
00431         QModelIndex index( model()-&gt;index( 0, pie, rootIndex() ) );
00432         <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_pie_attributes.html">PieAttributes</a> attrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama41">pieAttributes</a>( index ) );
00433         <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_three_d_pie_attributes.html">ThreeDPieAttributes</a> threeDAttrs( <a class="code" href="class_k_d_chart_1_1_abstract_pie_diagram.html#_k_d_chart_1_1_ring_diagrama79">threeDPieAttributes</a>( index ) );
00434 
00435         QRectF drawPosition = piePosition( dataset, pie );
00436 <span class="comment">//        QRectF drawPosition( d-&gt;position );</span>
00437 
00438 <span class="comment">/*        if ( attrs.explode() ) {</span>
00439 <span class="comment">            qreal explodeAngle = ( startAngle + angleLen / 2.0 );</span>
00440 <span class="comment">            qreal explodeAngleRad = DEGTORAD( explodeAngle );</span>
00441 <span class="comment">            qreal cosAngle = cos( explodeAngleRad );</span>
00442 <span class="comment">            qreal sinAngle = -sin( explodeAngleRad );</span>
00443 <span class="comment">            qreal explodeX = attrs.explodeFactor() * d-&gt;size * cosAngle;</span>
00444 <span class="comment">            qreal explodeY = attrs.explodeFactor() * d-&gt;size * sinAngle;</span>
00445 <span class="comment">            drawPosition.translate( explodeX, explodeY );</span>
00446 <span class="comment">        }else{</span>
00447 <span class="comment">            drawPosition = d-&gt;position;</span>
00448 <span class="comment">        }*/</span>
00449 
00450         QPen <a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagrama37">pen</a> = this-&gt;<a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagrama37">pen</a>( index );
00451         PainterSaver painterSaver( painter );
00452         painter-&gt;setRenderHint ( QPainter::Antialiasing );
00453         painter-&gt;setBrush( <a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagrama5">brush</a>( index ) );
00454         <span class="keywordflow">if</span> ( threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa1">isEnabled</a>() )
00455             pen.setColor( QColor( 0, 0, 0 ) );
00456         painter-&gt;setPen( pen );
00457 
00458         <span class="keywordflow">if</span> ( angleLen == 360 ) {
00459             <span class="comment">// full circle, avoid nasty line in the middle</span>
00460             painter-&gt;drawEllipse( drawPosition );
00461 <span class="comment">/*</span>
00462 <span class="comment">            if ( regions ) {</span>
00463 <span class="comment">                QPointArray hitregion;</span>
00464 <span class="comment">                hitregion.makeEllipse( drawPosition.x(), drawPosition.y(),</span>
00465 <span class="comment">                                       drawPosition.width(),</span>
00466 <span class="comment">                                       drawPosition.height() );</span>
00467 <span class="comment">                datReg = new KDChartDataRegion( region-&gt;unite( QRegion( hitregion ) ),</span>
00468 <span class="comment">                                                dataset,</span>
00469 <span class="comment">                                                pie,</span>
00470 <span class="comment">                                                chart );</span>
00471 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosCenter ]</span>
00472 <span class="comment">                    = drawPosition.center();</span>
00473 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosCenterRight ]</span>
00474 <span class="comment">                    = pointOnCircle( drawPosition,    0 );</span>
00475 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosTopRight ]</span>
00476 <span class="comment">                    = pointOnCircle( drawPosition,  45 );</span>
00477 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosTopCenter ]</span>
00478 <span class="comment">                    = pointOnCircle( drawPosition, 90 );</span>
00479 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosTopLeft ]</span>
00480 <span class="comment">                    = pointOnCircle( drawPosition, 135 );</span>
00481 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosCenterLeft ]</span>
00482 <span class="comment">                    = pointOnCircle( drawPosition, 180 );</span>
00483 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosBottomLeft ]</span>
00484 <span class="comment">                    = pointOnCircle( drawPosition, 225 );</span>
00485 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosBottomCenter ]</span>
00486 <span class="comment">                    = pointOnCircle( drawPosition, 270 );</span>
00487 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosBottomRight ]</span>
00488 <span class="comment">                    = pointOnCircle( drawPosition, 315 );</span>
00489 <span class="comment">                datReg-&gt;startAngle = 180;</span>
00490 <span class="comment">                datReg-&gt;angleLen   = 360;</span>
00491 <span class="comment">                regions-&gt;append( datReg );</span>
00492 <span class="comment">            }</span>
00493 <span class="comment">*/</span>
00494         } <span class="keywordflow">else</span> {
00495             <span class="comment">// draw the top of this piece</span>
00496             <span class="comment">// Start with getting the points for the arc.</span>
00497             <span class="keyword">const</span> <span class="keywordtype">int</span> arcPoints = static_cast&lt;int&gt;(trunc( angleLen / granularity ));
00498             QPolygonF poly( arcPoints+2 );
00499             qreal degree=0.0;
00500             <span class="keywordtype">int</span> iPoint = 0;
00501             <span class="keywordtype">bool</span> perfectMatch = <span class="keyword">false</span>;
00502 
00503             <span class="keywordflow">while</span> ( degree &lt;= angleLen ){
00504                 poly[ iPoint ] = pointOnCircle( drawPosition, startAngle + degree );
00505                 <span class="comment">//qDebug() &lt;&lt; degree &lt;&lt; angleLen &lt;&lt; poly[ iPoint ];</span>
00506                 perfectMatch = (degree == angleLen);
00507                 degree += granularity;
00508                 ++iPoint;
00509             }
00510             <span class="keywordtype">int</span> last = poly.size();
00511             <span class="comment">// if necessary add one more point to fill the last small gap</span>
00512             <span class="keywordflow">if</span>( ! perfectMatch ){
00513                 poly[ iPoint ] = pointOnCircle( drawPosition, startAngle + angleLen );
00514 
00515 <span class="comment">//qDebug() &lt;&lt; "adding" &lt;&lt; poly[ iPoint ];</span>
00516                 <span class="comment">// add the center point of the piece</span>
00517                 poly.append( drawPosition.center() );
00518 <span class="comment">//qDebug() &lt;&lt; "center:" &lt;&lt; poly[ ++iPoint ];</span>
00519             }<span class="keywordflow">else</span>{
00520                 poly[ iPoint ] = drawPosition.center();
00521 <span class="comment">//qDebug() &lt;&lt; "center:" &lt;&lt; poly[ iPoint ];</span>
00522             }
00523 <span class="comment">//qDebug() &lt;&lt; "a";</span>
00524             <span class="comment">//find the value and paint it</span>
00525             <span class="comment">//fix value position</span>
00526             <span class="keyword">const</span> qreal sum = <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama83">valueTotals</a>();
00527             painter-&gt;drawPolygon( poly );
00528 
00529             QLineF centerLine(  drawPosition.center(),
00530                             QPointF( (poly[ last - 2].x() + poly.first().x())/2,
00531                                      ( poly.first().y() + poly[last-2].y() )/2 ) );
00532             QPointF valuePos( ( centerLine.x1() + centerLine.x2() )/2,
00533                                   ( centerLine.y1() + centerLine.y2() )/2 ) ;
00534 
00535             <a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagrama32">paintDataValueText</a>( painter, index, valuePos, angleLen*sum / 360  );
00536 
00537 <span class="comment">//if( bHelp ){</span>
00538                             <span class="comment">//painter-&gt;drawPolyline( collect );</span>
00539 <span class="comment">//bHelp=false;</span>
00540 <span class="comment">//}</span>
00541 
00542 
00543 <span class="comment">/*</span>
00544 <span class="comment">            if ( regions ) {</span>
00545 <span class="comment">                QPointArray hitregion;</span>
00546 <span class="comment">                hitregion.makeArc( drawPosition.x(), drawPosition.y(),</span>
00547 <span class="comment">                        drawPosition.width(),</span>
00548 <span class="comment">                        drawPosition.height(),</span>
00549 <span class="comment">                        ( int ) startAngle, ( int ) angleLen );</span>
00550 <span class="comment">                hitregion.resize( hitregion.size() + 1 );</span>
00551 <span class="comment">                hitregion.setPoint( hitregion.size() - 1,</span>
00552 <span class="comment">                        drawPosition.center() );</span>
00553 <span class="comment">                datReg = new KDChartDataRegion( region-&gt;unite( QRegion( hitregion ) ),</span>
00554 <span class="comment">                                                dataset,</span>
00555 <span class="comment">                                                pie,</span>
00556 <span class="comment">                                                chart );</span>
00557 <span class="comment"></span>
00558 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosTopLeft ]</span>
00559 <span class="comment">                    = pointOnCircle( drawPosition, startAngle + angleLen );</span>
00560 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosTopCenter ]</span>
00561 <span class="comment">                    = pointOnCircle( drawPosition, startAngle + angleLen / 2 );</span>
00562 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosTopRight ]</span>
00563 <span class="comment">                    = pointOnCircle( drawPosition, startAngle );</span>
00564 <span class="comment"></span>
00565 <span class="comment">                datReg-&gt;points[   KDChartEnums::PosBottomLeft   ] = drawPosition.center();</span>
00566 <span class="comment">                datReg-&gt;points[   KDChartEnums::PosBottomCenter ]</span>
00567 <span class="comment">                    = datReg-&gt;points[ KDChartEnums::PosBottomLeft   ];</span>
00568 <span class="comment">                datReg-&gt;points[   KDChartEnums::PosBottomRight  ]</span>
00569 <span class="comment">                    = datReg-&gt;points[ KDChartEnums::PosBottomLeft   ];</span>
00570 <span class="comment"></span>
00571 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosCenterLeft ]</span>
00572 <span class="comment">                    = QPoint( (   datReg-&gt;points[ KDChartEnums::PosTopLeft      ].x()</span>
00573 <span class="comment">                                + datReg-&gt;points[ KDChartEnums::PosBottomLeft   ].x() ) / 2,</span>
00574 <span class="comment">                            (   datReg-&gt;points[ KDChartEnums::PosTopLeft      ].y()</span>
00575 <span class="comment">                                + datReg-&gt;points[ KDChartEnums::PosBottomLeft   ].y() ) / 2 );</span>
00576 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosCenter ]</span>
00577 <span class="comment">                    = QPoint( (   datReg-&gt;points[ KDChartEnums::PosTopCenter    ].x()</span>
00578 <span class="comment">                                + datReg-&gt;points[ KDChartEnums::PosBottomCenter ].x() ) / 2,</span>
00579 <span class="comment">                            (   datReg-&gt;points[ KDChartEnums::PosTopCenter    ].y()</span>
00580 <span class="comment">                                + datReg-&gt;points[ KDChartEnums::PosBottomCenter ].y() ) / 2 );</span>
00581 <span class="comment">                datReg-&gt;points[ KDChartEnums::PosCenterRight ]</span>
00582 <span class="comment">                    = QPoint( (   datReg-&gt;points[ KDChartEnums::PosTopRight     ].x()</span>
00583 <span class="comment">                                + datReg-&gt;points[ KDChartEnums::PosBottomRight  ].x() ) / 2,</span>
00584 <span class="comment">                            (   datReg-&gt;points[ KDChartEnums::PosTopRight     ].y()</span>
00585 <span class="comment">                                + datReg-&gt;points[ KDChartEnums::PosBottomRight  ].y() ) / 2 );</span>
00586 <span class="comment"></span>
00587 <span class="comment">                datReg-&gt;startAngle = startAngle;</span>
00588 <span class="comment">                datReg-&gt;angleLen   = angleLen;</span>
00589 <span class="comment">                regions-&gt;append( datReg );</span>
00590 <span class="comment">            }</span>
00591 <span class="comment">*/</span>
00592         }
00593 <span class="comment">//        if( mustDeleteRegion )</span>
00594 <span class="comment">//            delete region;</span>
00595     }
00596 }
00597 
00598 
00608 <span class="keywordtype">void</span> PieDiagram::draw3DEffect( QPainter* painter,
00609         <span class="keyword">const</span> QRectF&amp; drawPosition,
00610         uint dataset, uint pie,
00611         qreal granularity,
00612         <span class="keyword">const</span> <a class="code" href="class_k_d_chart_1_1_three_d_pie_attributes.html">ThreeDPieAttributes</a>&amp; threeDAttrs,
00613         <span class="keywordtype">bool</span> <span class="comment">/*explode*/</span> )
00614 {
00615     <span class="keywordflow">if</span>( ! threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa1">isEnabled</a>() )
00616         <span class="keywordflow">return</span>;
00617 
00618     <span class="comment">// NOTE: We cannot optimize away drawing some of the effects (even</span>
00619     <span class="comment">// when not exploding), because some of the pies might be left out</span>
00620     <span class="comment">// in future versions which would make some of the normally hidden</span>
00621     <span class="comment">// pies visible. Complex hidden-line algorithms would be much more</span>
00622     <span class="comment">// expensive than just drawing for nothing.</span>
00623 
00624     <span class="comment">// No need to save the brush, will be changed on return from this</span>
00625     <span class="comment">// method anyway.</span>
00626     <span class="keywordflow">if</span>( threeDAttrs.<a class="code" href="class_k_d_chart_1_1_three_d_pie_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa12">useShadowColors</a>() ){
00627         <span class="keyword">const</span> QPen pen = this-&gt;<a class="code" href="class_k_d_chart_1_1_abstract_diagram.html#_k_d_chart_1_1_ring_diagrama37">pen</a>( model()-&gt;index( 0, pie, rootIndex() ) );
00628         painter-&gt;setBrush( QBrush( pen.color() ) );
00629     }
00630     <span class="comment">//painter-&gt;setBrush( QBrush( threeDAttrs.dataShadow1Color( pie ),</span>
00631     <span class="comment">//            params()-&gt;shadowPattern() ) );</span>
00632 
00633     qreal startAngle = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ pie ];
00634     qreal endAngle = startAngle + <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ pie ];
00635     <span class="comment">// Normalize angles</span>
00636     <span class="keywordflow">while</span> ( startAngle &gt;= 360 )
00637         startAngle -= 360;
00638     <span class="keywordflow">while</span> ( endAngle &gt;= 360 )
00639         endAngle -= 360;
00640     Q_ASSERT( startAngle &gt;= 0 &amp;&amp; startAngle &lt;= 360 );
00641     Q_ASSERT( endAngle &gt;= 0 &amp;&amp; endAngle &lt;= 360 );
00642 
00643     <span class="comment">//int centerY = drawPosition.center().y();</span>
00644 
00645     <span class="keywordflow">if</span> ( startAngle == endAngle ||
00646             startAngle == endAngle - 360 ) { <span class="comment">// full circle</span>
00647         drawArcEffectSegment( painter, drawPosition,
00648                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00649                 180, 360, granularity );
00650     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( startAngle &lt;= 90 ) {
00651         <span class="keywordflow">if</span> ( endAngle &lt;= 90 ) {
00652             <span class="keywordflow">if</span> ( startAngle &lt;= endAngle ) {
00654                 drawStraightEffectSegment( painter, drawPosition,
00655                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00656                 drawUpperBrinkEffect( painter, drawPosition, endAngle );
00657             } <span class="keywordflow">else</span> {
00659                 drawStraightEffectSegment( painter, drawPosition,
00660                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00661                 drawUpperBrinkEffect( painter, drawPosition, endAngle );
00662                 drawArcEffectSegment( painter, drawPosition,
00663                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00664                     180, 360, granularity );
00665             }
00666         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endAngle &lt;= 180 ) {
00669             drawStraightEffectSegment( painter, drawPosition,
00670                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00671             drawStraightEffectSegment( painter, drawPosition,
00672                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00673         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endAngle &lt;= 270 ) {
00675             drawStraightEffectSegment( painter, drawPosition,
00676                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00677             drawStraightEffectSegment( painter, drawPosition,
00678                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00679             drawArcEffectSegment( painter, drawPosition,
00680                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00681                 180, endAngle, granularity );
00682         } <span class="keywordflow">else</span> { <span class="comment">// 270*16 &lt; endAngle &lt; 360*16</span>
00685 <span class="comment"></span>            drawStraightEffectSegment( painter, drawPosition,
00686                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00687             drawUpperBrinkEffect( painter, drawPosition, endAngle );
00688             drawArcEffectSegment( painter, drawPosition,
00689                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00690                 180, endAngle, granularity );
00691         }
00692     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( startAngle &lt;= 180 ) {
00693         <span class="keywordflow">if</span> ( endAngle &lt;= 90 ) {
00694             drawArcEffectSegment( painter, drawPosition,
00695                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00696                 180, 360, granularity );
00697             drawUpperBrinkEffect( painter, drawPosition, startAngle );
00698             drawUpperBrinkEffect( painter, drawPosition, endAngle );
00699         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endAngle &lt;= 180 ) {
00700             <span class="keywordflow">if</span> ( startAngle &lt;= endAngle ) {
00703                 drawStraightEffectSegment( painter, drawPosition,
00704                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00705                 drawUpperBrinkEffect( painter, drawPosition, startAngle );
00706             } <span class="keywordflow">else</span> {
00709                 drawStraightEffectSegment( painter, drawPosition,
00710                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00711                 drawUpperBrinkEffect( painter, drawPosition, startAngle );
00712                 drawArcEffectSegment( painter, drawPosition,
00713                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00714                     180, 360, granularity );
00715             }
00716         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endAngle &lt;= 270 ) {
00717             drawStraightEffectSegment( painter, drawPosition,
00718                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00719             drawUpperBrinkEffect( painter, drawPosition, startAngle );
00720             drawArcEffectSegment( painter, drawPosition,
00721                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00722                 180, endAngle, granularity );
00723         } <span class="keywordflow">else</span> { <span class="comment">// 270*16 &lt; endAngle &lt; 360*16</span>
00724             drawArcEffectSegment( painter, drawPosition,
00725                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00726                 180, endAngle, granularity );
00727             drawUpperBrinkEffect( painter, drawPosition, startAngle );
00728             drawUpperBrinkEffect( painter, drawPosition, endAngle );
00729         }
00730     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( startAngle &lt;= 270 ) {
00731         <span class="keywordflow">if</span> ( endAngle &lt;= 90 ) {
00732             drawArcEffectSegment( painter, drawPosition,
00733                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00734                 startAngle, 360, granularity );
00735             drawUpperBrinkEffect( painter, drawPosition, startAngle );
00736             drawUpperBrinkEffect( painter, drawPosition, endAngle );
00737         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endAngle &lt;= 180 ) {
00738             drawStraightEffectSegment( painter, drawPosition,
00739                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00740             drawUpperBrinkEffect( painter, drawPosition, startAngle );
00741             drawArcEffectSegment( painter, drawPosition,
00742                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00743                 startAngle, 360, granularity );
00744         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endAngle &lt;= 270 ) {
00745             <span class="keywordflow">if</span> ( startAngle &lt;= endAngle ) {
00748                 drawStraightEffectSegment( painter, drawPosition,
00749                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00750                 drawUpperBrinkEffect( painter, drawPosition, startAngle );
00751                 drawArcEffectSegment( painter, drawPosition,
00752                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00753                     startAngle, endAngle, granularity );
00754             } <span class="keywordflow">else</span> {
00757                 drawStraightEffectSegment( painter, drawPosition,
00758                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00759                 drawUpperBrinkEffect( painter, drawPosition, startAngle );
00760                 drawArcEffectSegment( painter, drawPosition,
00761                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00762                     180, endAngle, granularity );
00763                 drawArcEffectSegment( painter, drawPosition,
00764                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00765                     startAngle, 360, granularity );
00766             }
00767         } <span class="keywordflow">else</span> { <span class="comment">// 270*16 &lt; endAngle &lt; 360*16</span>
00768             drawArcEffectSegment( painter, drawPosition,
00769                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00770                 startAngle, endAngle, granularity );
00771             drawUpperBrinkEffect( painter, drawPosition, startAngle );
00772             drawUpperBrinkEffect( painter, drawPosition, endAngle );
00773         }
00774     } <span class="keywordflow">else</span> { <span class="comment">// 270*16 &lt; startAngle &lt; 360*16</span>
00775         <span class="keywordflow">if</span> ( endAngle &lt;= 90 ) {
00776             drawStraightEffectSegment( painter, drawPosition,
00777                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00778             drawUpperBrinkEffect( painter, drawPosition, endAngle );
00779             drawArcEffectSegment( painter, drawPosition,
00780                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00781                 startAngle, 360, granularity );
00782         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endAngle &lt;= 180 ) {
00783             drawStraightEffectSegment( painter, drawPosition,
00784                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00785             drawStraightEffectSegment( painter, drawPosition,
00786                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00787             drawArcEffectSegment( painter, drawPosition,
00788                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00789                 startAngle, 360, granularity );
00790         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endAngle &lt;= 270 ) {
00791             drawStraightEffectSegment( painter, drawPosition,
00792                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00793             drawStraightEffectSegment( painter, drawPosition,
00794                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), endAngle );
00795             drawArcEffectSegment( painter, drawPosition,
00796                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00797                 180, endAngle, granularity );
00798             drawArcEffectSegment( painter, drawPosition,
00799                 threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00800                 startAngle, 360, granularity );
00801         } <span class="keywordflow">else</span> { <span class="comment">// 270*16 &lt; endAngle &lt; 360*16</span>
00802             <span class="keywordflow">if</span> ( startAngle &lt;= endAngle ) {
00805                 drawStraightEffectSegment( painter, drawPosition,
00806                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00807                 drawUpperBrinkEffect( painter, drawPosition, endAngle );
00808                 drawArcEffectSegment( painter, drawPosition,
00809                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00810                     startAngle, endAngle, granularity );
00811             } <span class="keywordflow">else</span> {
00814                 drawStraightEffectSegment( painter, drawPosition,
00815                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(), startAngle );
00816                 drawUpperBrinkEffect( painter, drawPosition, endAngle );
00817                 drawArcEffectSegment( painter, drawPosition,
00818                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00819                     startAngle, 360, granularity );
00820                 drawArcEffectSegment( painter, drawPosition,
00821                     threeDAttrs.<a class="code" href="class_k_d_chart_1_1_abstract_three_d_attributes.html#_k_d_chart_1_1_three_d_pie_attributesa0">depth</a>(),
00822                     180, endAngle, granularity );
00823             }
00824         }
00825     }
00826     drawArcUpperBrinkEffectSegment( painter, drawPosition, startAngle, endAngle, granularity );
00827 }
00828 
00829 
00838 <span class="keywordtype">void</span> PieDiagram::drawStraightEffectSegment( QPainter* painter,
00839         <span class="keyword">const</span> QRectF&amp; rect,
00840         qreal threeDHeight,
00841         qreal angle )
00842 {
00843     QPolygonF poly( 4 );
00844     <span class="keyword">const</span> QPointF center = rect.center();
00845     <span class="keyword">const</span> QPointF circlePoint = pointOnCircle( rect, angle );
00846     poly[0] = center;
00847     poly[1] = circlePoint;
00848     poly[2] = QPointF( circlePoint.x(), circlePoint.y() + threeDHeight );
00849     poly[3] = QPointF( center.x(), center.y() + threeDHeight );
00850     painter-&gt;drawPolygon( poly );
00851 <span class="comment">//    if ( region )</span>
00852 <span class="comment">//        *region += QRegion( points );</span>
00853 }
00854 
00862 <span class="keywordtype">void</span> PieDiagram::drawUpperBrinkEffect( QPainter* painter,
00863         <span class="keyword">const</span> QRectF&amp; rect,
00864         qreal angle )
00865 {
00866     <span class="keyword">const</span> QPointF center = rect.center();
00867     <span class="keyword">const</span> QPointF circlePoint = pointOnCircle( rect, angle );
00868     painter-&gt;drawLine( center, circlePoint );
00869 }
00870 
00880 <span class="keywordtype">void</span> PieDiagram::drawArcEffectSegment( QPainter* painter,
00881         <span class="keyword">const</span> QRectF&amp; rect,
00882         qreal threeDHeight,
00883         qreal startAngle,
00884         qreal endAngle,
00885         qreal granularity )
00886 {
00887     <span class="comment">// Start with getting the points for the inner arc.</span>
00888     qreal startA = qMin( startAngle, endAngle );
00889     qreal endA   = qMax( startAngle, endAngle );
00890 
00891     <span class="comment">// sometimes we have to draw two segments, which are on different sides of the pie</span>
00892     <span class="keywordflow">if</span>( endA &gt; 540 )
00893         drawArcEffectSegment( painter, rect, threeDHeight, 180, endA - 360, granularity );
00894     <span class="keywordflow">if</span>( endA &gt; 360 )
00895         endA = qMin( endA, 360.0 );
00896 
00897     <span class="keywordtype">int</span> numHalfPoints = static_cast&lt;int&gt;( trunc( ( endA - startA ) / granularity ) ) + 1;
00898 
00899     QPolygonF poly( numHalfPoints );
00900 
00901     qreal degree = endA;
00902     <span class="keywordtype">int</span> iPoint = 0;
00903     <span class="keywordtype">bool</span> perfectMatch = <span class="keyword">false</span>;
00904     <span class="keywordflow">while</span> ( degree &gt;= startA ){
00905         poly[ numHalfPoints - iPoint - 1 ] = pointOnCircle( rect, degree );
00906 
00907         perfectMatch = (degree == startA);
00908         degree -= granularity;
00909         ++iPoint;
00910     }
00911     <span class="comment">// if necessary add one more point to fill the last small gap</span>
00912     <span class="keywordflow">if</span>( ! perfectMatch ){
00913         poly.prepend( pointOnCircle( rect, startA ) );
00914         ++numHalfPoints;
00915     }
00916 
00917     poly.resize( numHalfPoints * 2 );
00918 
00919     <span class="comment">// Now copy these arcs again into the final array, but in the</span>
00920     <span class="comment">// opposite direction and moved down by the 3D height.</span>
00921     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = numHalfPoints - 1; i &gt;= 0; --i ) {
00922         QPointF pointOnFirstArc( poly[ i ] );
00923         pointOnFirstArc.setY( pointOnFirstArc.y() + threeDHeight );
00924         poly[ numHalfPoints * 2 - i - 1 ] = pointOnFirstArc;
00925     }
00926 
00927     painter-&gt;drawPolygon( poly );
00928 <span class="comment">//    if ( region )</span>
00929 <span class="comment">//        *region += QRegion( collect );</span>
00930 }
00931 
00940 <span class="keywordtype">void</span> PieDiagram::drawArcUpperBrinkEffectSegment( QPainter* painter,
00941         <span class="keyword">const</span> QRectF&amp; rect,
00942         qreal startAngle,
00943         qreal endAngle,
00944         qreal granularity )
00945 {
00946     <span class="keywordflow">if</span> ( endAngle &lt; startAngle )
00947         endAngle += 360;
00948     <span class="comment">// Start with getting the poits for the inner arc.</span>
00949     <span class="keyword">const</span> qreal startA = qMin( startAngle, endAngle );
00950     <span class="keyword">const</span> qreal endA   = qMax( startAngle, endAngle );
00951 
00952     <span class="keywordtype">int</span> numHalfPoints = static_cast&lt;int&gt;( trunc( ( endA - startA ) / granularity ) ) + 1;
00953 
00954     QPolygonF poly( numHalfPoints );
00955 
00956     qreal degree = endA;
00957     <span class="keywordtype">int</span> iPoint = 0;
00958     <span class="keywordtype">bool</span> perfectMatch = <span class="keyword">false</span>;
00959     <span class="keywordflow">while</span> ( degree &gt;= startA ){
00960         poly[ numHalfPoints - iPoint - 1 ] = pointOnCircle( rect, degree );
00961 
00962         perfectMatch = (degree == startA);
00963         degree -= granularity;
00964         ++iPoint;
00965     }
00966     <span class="comment">// if necessary add one more point to fill the last small gap</span>
00967     <span class="keywordflow">if</span>( ! perfectMatch ){
00968         poly.prepend( pointOnCircle( rect, startA ) );
00969         ++numHalfPoints;
00970     }
00971 
00972     painter-&gt;drawPolyline( poly );
00973 <span class="comment">//    if ( region )</span>
00974 <span class="comment">//        *region += QRegion( collect );</span>
00975 }
00976 
00984 uint PieDiagram::findPieAt( qreal angle, <span class="keywordtype">int</span> colCount )
00985 {
00986     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; colCount; ++i ) {
00987         qreal endseg = <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ i ] + <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;angleLens[ i ];
00988         <span class="keywordflow">if</span> ( ( <a class="code" href="_k_d_chart_abstract_area_8cpp.html#a0">d</a>-&gt;startAngles[ i ] &lt;= angle ) &amp;&amp;
00989                 ( endseg &gt;= angle ) )
00990             <span class="comment">// found!</span>
00991             <span class="keywordflow">return</span> i;
00992     }
00993 
00994     <span class="comment">// If we have not found it, try wrap around</span>
00995     <span class="comment">// but only if the current searched angle is &lt; 360 degree</span>
00996     <span class="keywordflow">if</span> ( angle &lt; 360 )
00997         <span class="keywordflow">return</span> findPieAt( angle + 360, colCount );
00998     <span class="comment">// otherwise - what ever went wrong - we return 0</span>
00999     <span class="keywordflow">return</span> 0;
01000 }
01001 
01002 
01010 uint PieDiagram::findLeftPie( uint pie, <span class="keywordtype">int</span> colCount )
01011 {
01012     <span class="keywordflow">if</span> ( pie == 0 )
01013         <span class="keywordflow">if</span> ( colCount &gt; 1 )
01014             <span class="keywordflow">return</span> colCount - 1;
01015         <span class="keywordflow">else</span>
01016             <span class="keywordflow">return</span> 0;
01017     <span class="keywordflow">else</span> {
01018         <span class="keywordflow">return</span> pie - 1;
01019     }
01020 }
01021 
01022 
01030 uint PieDiagram::findRightPie( uint pie, <span class="keywordtype">int</span> colCount  )
01031 {
01032     <span class="keywordtype">int</span> rightpie = pie + 1;
01033     <span class="keywordflow">if</span> ( rightpie == colCount )
01034         rightpie = 0;
01035     <span class="keywordflow">return</span> rightpie;
01036 }
01037 
01038 <span class="comment">/*</span>
01039 <span class="comment">/ **</span>
01040 <span class="comment">  This method is a specialization that returns a fallback legend text</span>
01041 <span class="comment">  appropriate for pies that do not have more than one dataset</span>
01042 <span class="comment"></span>
01043 <span class="comment">  This method is only used when automatic legends are used, because</span>
01044 <span class="comment">  manual and first-column legends do not need fallback texts.</span>
01045 <span class="comment"></span>
01046 <span class="comment">  \param uint dataset the dataset number for which to generate a</span>
01047 <span class="comment">  fallback text</span>
01048 <span class="comment">  \return the fallback text to use for describing the specified</span>
01049 <span class="comment">  dataset in the legend</span>
01050 <span class="comment">  * /</span>
01051 <span class="comment">QString PieDiagram::fallbackLegendText( uint dataset ) const</span>
01052 <span class="comment">{</span>
01053 <span class="comment">    return QObject::tr( "Item " ) + QString::number( dataset + 1 );</span>
01054 <span class="comment">}</span>
01055 <span class="comment"></span>
01056 <span class="comment"></span>
01057 <span class="comment">/ **</span>
01058 <span class="comment">  This methods returns the number of elements to be shown in the</span>
01059 <span class="comment">  legend in case fallback texts are used.</span>
01060 <span class="comment"></span>
01061 <span class="comment">  This method is only used when automatic legends are used, because</span>
01062 <span class="comment">  manual and first-column legends do not need fallback texts.</span>
01063 <span class="comment"></span>
01064 <span class="comment">  \return the number of fallback texts to use</span>
01065 <span class="comment">  * /</span>
01066 <span class="comment">uint PieDiagram::numLegendFallbackTexts( KDChartTableDataBase* data ) const</span>
01067 <span class="comment">{</span>
01068 <span class="comment">    return data-&gt;usedCols();</span>
01069 <span class="comment">}</span>
01070 <span class="comment">*/</span>
01071 
01076 QPointF PieDiagram::pointOnCircle( <span class="keyword">const</span> QRectF&amp; rect, qreal angle )
01077 {
01078     qreal angleRad = DEGTORAD( angle );
01079     qreal cosAngle = cos( angleRad );
01080     qreal sinAngle = -sin( angleRad );
01081     qreal posX = cosAngle * rect.width() / 2.0;
01082     qreal posY = sinAngle * rect.height() / 2.0;
01083     <span class="keywordflow">return</span> QPointF( posX + rect.center().x(),
01084                     posY + rect.center().y() );
01085 
01086 }
01087 
01088 <span class="comment">/*virtual*/</span>
<a name="l01089"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama83">01089</a> <span class="keywordtype">double</span> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama83">PieDiagram::valueTotals</a>()<span class="keyword"> const</span>
01090 <span class="keyword"></span>{
01091     <span class="keyword">const</span> <span class="keywordtype">int</span> colCount = <a class="code" href="class_k_d_chart_1_1_abstract_polar_diagram.html#_k_d_chart_1_1_ring_diagrama7">columnCount</a>();
01092     <span class="keywordtype">double</span> total = 0.0;
01093     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; colCount; ++j ) {
01094       total += qAbs(model()-&gt;data( model()-&gt;index( 0, j, rootIndex() ) ).toDouble());
01095       <span class="comment">//qDebug() &lt;&lt; model()-&gt;data( model()-&gt;index( 0, j, rootIndex() ) ).toDouble();</span>
01096     }
01097     <span class="keywordflow">return</span> total;
01098 }
01099 
01100 <span class="comment">/*virtual*/</span>
<a name="l01101"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama31">01101</a> <span class="keywordtype">double</span> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama31">PieDiagram::numberOfValuesPerDataset</a>()<span class="keyword"> const</span>
01102 <span class="keyword"></span>{
01103     <span class="keywordflow">return</span> model() ? model()-&gt;columnCount( rootIndex() ) : 0.0;
01104 }
01105 
01106 <span class="comment">/*virtual*/</span>
<a name="l01107"></a><a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama30">01107</a> <span class="keywordtype">double</span> <a class="code" href="class_k_d_chart_1_1_pie_diagram.html#_k_d_chart_1_1_pie_diagrama30">PieDiagram::numberOfGridRings</a>()<span class="keyword"> const</span>
01108 <span class="keyword"></span>{
01109     <span class="keywordflow">return</span> 1;
01110 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 10 11:06:25 2007 for KD Chart 2 by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
